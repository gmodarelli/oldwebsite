<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Code Reviews with Rubocop and Git pre-commit hook | Giuseppe Modarelli</title>

    <!-- Bootstrap -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

<!-- Base -->
<link rel="stylesheet" href="/css/base.css">

<!-- Github Flavored Markdown Style -->
<link rel="stylesheet" href="/github-markdown-css/github-markdown.css">

<!-- Github Code Highlight -->
<link rel="stylesheet" href="/node_modules/highlight.js/styles/github.css">
  </head>

  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Giuseppe Modarelli</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
    </div><!--/.navbar-collapse -->
  </div>
</nav>

    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <h1><a href="/2015/01/code_reviews_rubocop_pre_commit">Code Reviews with Rubocop and Git pre-commit hook</a></h1>
          <h6>February 16, 2015</h6>

          <article class="markdown-body">
            <p>We are different. We have different coding styles and even preferences and this is not a problem.
Until of course you start to work in team. The most annoying thing during code reviews is to check and fix styling errors.
Or even worse someone asks you to fix your code because it does not meet the style guidelines.</p>
<p>There’s no official style guide for Ruby but fortunately we have
<a href="https://github.com/bbatsov/ruby-style-guide">a community-driven Ruby coding style guide</a>.
Still, checking every time if your code adheres to the standard is painful.</p>
<p>But again Ruby has a great community and a great set of tools to help us with this problem.
My favourite is <a href="https://github.com/bbatsov/rubocop">RuboCop</a>:</p>
<blockquote>
<p>RuboCop is a Ruby static code analyzer.
Out of the box it will enforce many of the guidelines outlined in the community <a href="https://github.com/bbatsov/ruby-style-guide">Ruby Style Guide</a>.</p>
</blockquote>
<h2>Rubocop</h2>
<p>Using RuboCop is really easy. You add it to your Gemfile and run rubocop from the root of your application.
It will show a list of offences in your source code.</p>
<p>RuboCop provides a set of <a href="https://github.com/bbatsov/rubocop/blob/master/config/default.yml">default configuration options</a>
that you can tweak to fit your team style.</p>
<p>Until you get familiar with all the Style Guides you will need to run rubocop on your code multiple times.
But as with anything that is not automated you will end up forgetting to run it manually (I did).</p>
<h2>Git Pre Commit Hook</h2>
<p>I used a simple git pre-commit hook that runs rubocop for me everytime I commit some code. And it does more.</p>
<p>It runs rubocop only against the staged files and it will not commit if it finds offences.</p>
<p>The pre-commit is a simple bash script</p>
<pre><code class="language-bash"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Check for ruby style errors</span>

red=<span class="hljs-string">'\033[0;31m'</span>
green=<span class="hljs-string">'\033[0;32m'</span>
yellow=<span class="hljs-string">'\033[0;33m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-keyword">if</span> git rev-parse --verify HEAD &gt;/dev/null 2&gt;&amp;1
<span class="hljs-keyword">then</span>
	against=HEAD
<span class="hljs-keyword">else</span>
	<span class="hljs-comment"># Initial commit: diff against an empty tree object</span>
	<span class="hljs-comment"># Change it to match your initial commit sha</span>
	against=123acdac4c698f24f2352cf34c3b12e246b48af1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># Check if rubocop is installed for the current project</span>
bin/bundle <span class="hljs-built_in">exec</span> rubocop -v &gt;/dev/null 2&gt;&amp;1 || { <span class="hljs-built_in">echo</span> &gt;&amp;2 <span class="hljs-string">"<span class="hljs-variable">${red}</span>[Ruby Style][Fatal]: Add rubocop to your Gemfile"</span>; <span class="hljs-built_in">exit</span> 1; }

<span class="hljs-comment"># Get only the staged files</span>
FILES=<span class="hljs-string">"<span class="hljs-variable">$(git diff --cached --name-only --diff-filter=AMC | grep "\.rb$" | tr '\n' ' ')</span>"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${green}</span>[Ruby Style][Info]: Checking Ruby Style<span class="hljs-variable">${NC}</span>"</span>

<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$FILES</span>"</span> ]
<span class="hljs-keyword">then</span>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${green}</span>[Ruby Style][Info]: <span class="hljs-variable">${FILES}</span><span class="hljs-variable">${NC}</span>"</span>
	
	<span class="hljs-keyword">if</span> [ ! <span class="hljs-_">-f</span> <span class="hljs-string">'.rubocop.yml'</span> ]; <span class="hljs-keyword">then</span>
	  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${yellow}</span>[Ruby Style][Warning]: No .rubocop.yml config file.<span class="hljs-variable">${NC}</span>"</span>
	<span class="hljs-keyword">fi</span>
	
	<span class="hljs-comment"># Run rubocop on the staged files</span>
	bin/bundle <span class="hljs-built_in">exec</span> rubocop <span class="hljs-variable">${FILES}</span>
	
	<span class="hljs-keyword">if</span> [ $? <span class="hljs-_">-ne</span> 0 ]; <span class="hljs-keyword">then</span>
	  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${red}</span>[Ruby Style][Error]: Fix the issues and commit again<span class="hljs-variable">${NC}</span>"</span>
	  <span class="hljs-built_in">exit</span> 1
	<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">else</span>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${green}</span>[Ruby Style][Info]: No files to check<span class="hljs-variable">${NC}</span>"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">exit</span> 0
</code></pre>
<h2>Put everything together</h2>
<p>If you want to try it on your ruby projects follow these simple steps:</p>
<ol>
<li>Add <code>rubocop</code> to your <code>Gemfile</code></li>
</ol>
<pre><code class="language-ruby">gem <span class="hljs-string">'rubocop'</span>, <span class="hljs-string">'~&gt; 0.29.0'</span>, <span class="hljs-symbol">require:</span> <span class="hljs-keyword">false</span>
</code></pre>
<ol start="2">
<li>
<p>Run <code>bundle install</code></p>
</li>
<li>
<p>Create a <code>.rubocop.yml</code> file with your configurations. If you don’t, RuboCop will use the default settings.</p>
</li>
<li>
<p>Copy my gist above and paste it in your project’s hook directory. Save the file as <strong>pre-commit</strong> (your-project/.git/hooks/pre-commit)</p>
</li>
<li>
<p>Change the pre-commit permissions with <code>chmod +x your-project/.git/hooks/pre-commit</code></p>
</li>
</ol>
<p>Every time you run git commit rubocop will check all the staged files for you and will prevent you
from committing code that does not adhere to your team standard.</p>
<p>Happy coding!</p>

          </article>
        </div>
      </div>
    </div>

    <!-- jQuery for Bootstrap -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  </body>
</html>

